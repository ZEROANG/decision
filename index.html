<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çº ç»“ç»ˆç«¯æœº</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§­</text></svg>">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%236c5ce7%22 rx=%2220%22/><text x=%225%22 y=%22.85em%22 font-size=%2280%22>ğŸ§­</text></svg>">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #fdcb6e;
            --pro: #00b894;
            --con: #ff7675;
            --bg: #f8f9fb;
            --card: #ffffff;
            --star-empty: #dfe6e9;
            --star-filled: #fdcb6e;
            --text-main: #2d3436;
            --text-muted: #b2bec3;
        }

        body {
            font-family: 'PingFang SC', -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            padding-bottom: 80px;
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            min-height: 100vh;
            background: var(--card);
            margin: 0 auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-top: env(safe-area-inset-top, 20px);
        }

        /* ä¿®å¤å¤©å¹³åˆ—æº¢å‡ºï¼šè®©å®¹å™¨æ”¯æŒæ¢è¡Œæˆ–è‡ªé€‚åº”æ¯”ä¾‹ */
        .balance-grid {
            display: flex;
            /* å»ºè®®å°† grid æ”¹ä¸º flex */
            gap: 15px;
            width: 100%;
            box-sizing: border-box;
            justify-content: space-between;
        }

        /* é‡ç‚¹ï¼šç»™å¤©å¹³å·¦å³ä¸¤åˆ—å„åˆ†é… 50% å®½åº¦ï¼Œé˜²æ­¢æ’‘ç ´å±å¹• */
        .bal-column {
            flex: 1;
            min-width: 0;
            /* å…è®¸æ”¶ç¼© */
            width: 48%;
            /* ç¨å¾®å°äº50%ï¼Œç•™å‡ºgap */
            word-break: break-all;
            /* å¼ºåˆ¶è¿‡é•¿æ–‡å­—æ¢è¡Œ */
        }

        /* ä¿®å¤å¯¹æ¯”å†³ç­–æ ‡é¢˜æ è¢«é®æŒ¡ï¼šå¢åŠ é¡µé¢é¡¶éƒ¨çš„å®‰å…¨è·ç¦» */
        .page {
            padding-top: 20px;
            /* é€‚å½“å¢åŠ é¡¶éƒ¨å†…è¾¹è· */
            box-sizing: border-box;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        /* ç§»åŠ¨ç«¯ç‰¹æ®Šé€‚é…ï¼šå½“å±å¹•è¿‡çª„æ—¶è°ƒæ•´å­—ä½“å’Œé—´è· */
        @media (max-width: 375px) {
            h2 {
                font-size: 1.2rem;
            }

            .btn-primary {
                padding: 10px;
                font-size: 14px;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            display: flex;
            align-items: center;
            background: #f1f3f5;
            border-radius: 12px;
            padding: 4px 12px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .input-group:focus-within {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .input-group input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 0;
            outline: none;
            font-size: 14px;
            color: var(--text-main);
        }

        /* æ¨¡å¼ç‰¹å®šè¾“å…¥èƒŒæ™¯ */
        .pro-bg {
            background: #e6fffa !important;
        }

        .con-bg {
            background: #fff5f5 !important;
        }

        .del-btn {
            color: #b2bec3;
            cursor: pointer;
            padding: 5px;
            font-size: 18px;
            margin-left: 5px;
        }

        .del-btn:hover {
            color: var(--con);
        }

        /* å†å²æ ‡ç­¾ï¼šå®å¿ƒåº•è‰²ç™½å­— */
        .mode-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 6px;
            display: inline-block;
            color: white;
        }

        /* å¡ç‰‡æ ·å¼ */
        .mode-card {
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid #f1f3f5;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.06);
        }

        /* å†å²æ‹–æ‹½ */
        .history-item {
            cursor: grab;
            position: relative;
        }

        .dragging {
            opacity: 0.4;
            border: 2px dashed var(--primary);
        }

        /* æŒ‰é’® */
        .btn {
            padding: 15px;
            border-radius: 14px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-back {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #eee;
            cursor: pointer;
            font-size: 18px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è¯„åˆ†çŸ©é˜µ */
        .crit-card {
            background: #f8f9ff;
            border: 1px solid #e0e4ff;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
        }

        .star-group {
            display: flex;
            gap: 4px;
            font-size: 26px;
            margin-top: 5px;
        }

        .star-box {
            cursor: pointer;
            color: var(--star-empty);
        }

        .star-box.active {
            color: var(--star-filled);
        }

        .section-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 20px 0 10px;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            height: 70px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 1px solid #eee;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: bold;
        }

        /* æŠ–åŠ¨åŠ¨ç”» */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* é”™è¯¯çŠ¶æ€ä¸‹çš„è¾“å…¥æ¡†æ ·å¼ */
        .input-error {
            border-color: var(--con) !important;
            background-color: #fff5f5 !important;
            animation: shake 0.3s ease-in-out;
        }

        /* é”™è¯¯æç¤ºå°å­— */
        .error-tip {
            color: var(--con);
            font-size: 11px;
            margin-top: -8px;
            margin-bottom: 10px;
            margin-left: 4px;
            display: none;
            /* é»˜è®¤éšè— */
        }

        /* å¼¹çª—èƒŒæ™¯é®ç½© */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s;
        }

        /* å¼¹çª—ä¸»ä½“ */
        .modal-content {
            background: white;
            width: 85%;
            max-width: 320px;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            animation: modalPop 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.28);
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-text {
            font-size: 16px;
            color: var(--text-main);
            margin-bottom: 25px;
            line-height: 1.5;
            font-weight: 500;
        }

        .modal-btns {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 24px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            flex: 1;
        }

        /* ç¡®è®¤æŒ‰é’®æ ·å¼ */
        .modal-btn.confirm {
            background: var(--primary);
            color: white;
        }

        .modal-btn.confirm:active {
            transform: scale(0.95);
            opacity: 0.9;
        }

        /* å–æ¶ˆæŒ‰é’®æ ·å¼ */
        .modal-btn.cancel {
            background: #f1f2f6;
            color: var(--text-muted);
        }

        .modal-btn.cancel.hidden {
            display: none;
        }

        /* å½“åªæœ‰æç¤ºæ—¶éšè—å–æ¶ˆ */
    </style>
</head>

<body>

    <div class="app-container">
        <div id="page-home" class="page">
            <div style="text-align:center; padding:40px 0 20px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ§­</div>
                <h2 style="margin:0; font-weight: 800;">çº ç»“ç»ˆç«¯æœº</h2>
                <p style="color:var(--text-muted); font-size: 0.85rem; margin-top: 5px;">è®©æ„Ÿæ€§å›å½’å¤©å¹³ï¼Œè®©ç†æ€§ç»ˆç»“çŠ¹è±«ï¼Œåšå†³ç­–ä¸å†å›°éš¾</p>
            </div>
            <div class="mode-card" onclick="openMode('balance')">
                <div>
                    <h3 style="margin:0; color:var(--secondary);">âš–ï¸ å¤©å¹³å†³ç­–</h3>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">è¯¥ä¸è¯¥åšæŸäº‹ï¼Ÿåˆ©å¼Šæƒé‡åˆ†æã€‚</p>
                </div><span style="color:#ddd; font-size:24px;">â€º</span>
            </div>
            <div class="mode-card" onclick="openMode('advanced')">
                <div>
                    <h3 style="margin:0; color:var(--primary);">ğŸ“Š å¯¹æ¯”å†³ç­–</h3>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">å¤šä¸ªé€‰é¡¹é€‰ä¼˜ï¼Ÿå¤šç»´åº¦åŠ æƒè¯„åˆ†ã€‚</p>
                </div><span style="color:#ddd; font-size:24px;">â€º</span>
            </div>
            <div class="mode-card" onclick="openMode('random')">
                <div>
                    <h3 style="margin:0; color:var(--accent);">ğŸ¯ éšæœºå†³ç­–</h3>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">åƒä»€ä¹ˆä¹°ä»€ä¹ˆï¼Ÿäº¤ç»™æ¦‚ç‡æ¥å®šå¤ºã€‚</p>
                </div><span style="color:#ddd; font-size:24px;">â€º</span>
            </div>
            <div style="text-align:center; color:#eee; font-size:12px; margin-top:30px;">ç‰ˆæœ¬å·ï¼š1.0.2</div>

        </div>

        <div id="page-balance" class="page hidden">
            <div style="display:flex; align-items:center; margin-bottom:20px;"><button class="btn-back"
                    onclick="switchPage('home')">â€¹</button>
                <h3 style="margin:0">å¤©å¹³å†³ç­–</h3>
            </div>

            <div class="input-group"><input type="text" id="bal-title" placeholder="å†³ç­–æ ‡é¢˜ï¼ˆå¦‚ï¼šè¯¥ä¸è¯¥ä¹°iPadï¼Ÿï¼‰"
                    oninput="checkLen(this, 20); autoSaveAfterTitleInput('balance')"></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <div class="section-title" style="color:var(--pro)">ğŸŸ¢ æ”¶ç›Š/å¥½å¤„</div>
                    <div id="pro-list"></div>
                    <button onclick="addBalItem('pro')"
                        style="width:100%; border:1px dashed var(--pro); background:none; color:var(--pro); padding:8px; border-radius:12px; font-size:11px; cursor:pointer;">+
                        å¢åŠ å¥½å¤„</button>
                </div>
                <div>
                    <div class="section-title" style="color:var(--con)">ğŸ”´ ä»£ä»·/é¡¾è™‘</div>
                    <div id="con-list"></div>
                    <button onclick="addBalItem('con')"
                        style="width:100%; border:1px dashed var(--con); background:none; color:var(--con); padding:8px; border-radius:12px; font-size:11px; cursor:pointer;">+
                        å¢åŠ ä»£ä»·</button>
                </div>
            </div>
            <div id="bal-res-panel" class="hidden"
                style="margin-top:20px; padding:20px; border-radius:16px; text-align:center; transition: 0.3s;"></div>
            <button class="btn btn-secondary" style="margin-top:24px;" onclick="doCalcBalance()">å¼€å§‹å†³ç­–</button>
        </div>

        <div id="page-advanced" class="page hidden">
            <div style="display:flex; align-items:center; margin-bottom:20px;"><button class="btn-back"
                    onclick="switchPage('home')">â€¹</button>
                <h3 style="margin:0">å¯¹æ¯”å†³ç­–</h3>
            </div>
            <div id="adv-setup">
                <div class="input-group"><input type="text" id="adv-title" placeholder="å†³ç­–æ ‡é¢˜ï¼ˆå¦‚ï¼šé€‰æ‹©å“ªä¸€ä¸ªå·¥ä½œ Offerï¼Ÿï¼‰"
                        oninput="checkLen(this, 20); autoSaveAfterTitleInput('advanced')"></div>
                <div class="section-title">âš–ï¸ è¯„ä»·æ ‡å‡† (æ»‘åŠ¨è®¾ç½®æƒé‡)</div>
                <div id="crit-list"></div>
                <button class="btn" style="background:#f1f3f5; font-size:0.8rem;" onclick="addCritField('', 50)">+
                    å¢åŠ æ ‡å‡†</button>
                <div class="section-title" style="margin-top:20px;">ğŸ“¦ æ¯”è¾ƒå¯¹è±¡</div>
                <div id="obj-list"></div>
                <button class="btn" style="background:#f1f3f5; font-size:0.8rem;" onclick="addObjField('')">+
                    å¢åŠ å¯¹è±¡</button>
                <button class="btn btn-primary" style="margin-top:24px;" onclick="goScoringPage()">ä¸‹ä¸€æ­¥ï¼šå¼€å§‹æ‰“åˆ†</button>
            </div>
            <div id="adv-scoring-ui" class="hidden">
                <div id="scoring-matrix"></div>
                <div id="adv-res-panel" class="hidden"
                    style="margin:20px 0; padding:20px; border-radius:16px; border:2px solid var(--primary); text-align:center; background:#f8f9ff;">
                </div>
                <button class="btn btn-primary" onclick="doCalcAdvanced()">å¼€å§‹å†³ç­–</button>
                <button class="btn" style="background:none; color:var(--primary)" onclick="toggleScoring(false)">â€¹
                    è¿”å›ä¿®æ”¹è¯„ä»·æƒé‡å’Œå¯¹è±¡</button>
            </div>
        </div>

        <div id="page-random" class="page hidden">
            <div style="display:flex; align-items:center; margin-bottom:20px;"><button class="btn-back"
                    onclick="switchPage('home')">â€¹</button>
                <h3 style="margin:0">éšæœºå†³ç­–</h3>
            </div>
            <div class="input-group"><input type="text" id="ran-title" placeholder="å†³ç­–æ ‡é¢˜ï¼ˆå¦‚ï¼šæ™šä¸Šåƒä»€ä¹ˆï¼Ÿï¼‰"
                    oninput="checkLen(this, 20); autoSaveAfterTitleInput('random')"></div>
            <div class="section-title">ğŸ¯ å€™é€‰åˆ—è¡¨</div>
            <div id="ran-list"></div>
            <button class="btn" style="background:#f1f3f5;" onclick="addRanField('')">+ æ·»åŠ é€‰é¡¹</button>
            <div id="ran-machine" class="hidden"
                style="height:80px; background:#2d3436; border-radius:16px; margin:24px 0; border:4px solid var(--accent); position:relative; overflow:hidden;">
                <div id="ran-track"
                    style="position:absolute; width:100%; transition: transform 3s cubic-bezier(0.1, 0, 0.1, 1);"></div>
            </div>
            <div id="ran-res-panel"
                style="text-align:center; font-size:1.6rem; font-weight:800; color:var(--primary); min-height:40px;">
            </div>
            <button class="btn btn-primary" style="background:var(--accent); color:#2d3436; margin-top:20px;"
                onclick="doRandomDecision()">å¼€å§‹å†³ç­–</button>
        </div>

        <div id="page-history" class="page hidden">
            <h3 style="margin-bottom:20px;">ğŸ•’ å†å²å†³ç­–</h3>
            <p style="font-size: 11px; color: var(--text-muted); margin: -18px 0 15px 2.5em; line-height: 1.2;">
                é•¿æŒ‰å¹¶æ‹–æ‹½è®°å½•å¯è°ƒæ•´æ˜¾ç¤ºé¡ºåº</p>
            <div id="history-container"></div>
        </div>

        <div class="navbar">
            <div class="nav-item active" id="nav-home" onclick="switchPage('home')">ğŸ <span>é¦–é¡µ</span></div>
            <div class="nav-item" id="nav-history" onclick="switchPage('history')">ğŸ•’<span>å†å²</span></div>
        </div>
    </div>

    <!-- <div id="custom-toast" class="hidden"
        style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.8); color:white; padding:15px 25px; border-radius:30px; z-index:9999; text-align:center; min-width:200px; box-shadow:0 10px 30px rgba(0,0,0,0.2); pointer-events:none; transition: opacity 0.3s;">
    </div> -->

    <div id="custom-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="modal-body" class="modal-text">æç¤ºå†…å®¹</div>
            <div id="modal-footer" class="modal-btns"><button id="modal-cancel-btn"
                    class="modal-btn cancel">å–æ¶ˆ</button><button id="modal-confirm-btn"
                    class="modal-btn confirm">ç¡®å®š</button></div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('terminal_db_vfinal') || '[]');
        let activeId = null;
        let currentMatrixData = {};

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (document.getElementById(`nav-${p}`)) document.getElementById(`nav-${p}`).classList.add('active');
            if (p === 'history') renderHistoryList();
        }

        // è¾…åŠ©åŠŸèƒ½
        function checkLen(el, max) {
            if (el.value.length > max) {
                el.value = el.value.substring(0, max);
                openModal(`âŒ å­—æ•°ä¸Šé™ä¸º ${max} å­—å“¦`);
            }
        }

        function canDelete(containerId, min) {
            return document.getElementById(containerId).children.length > min;
        }

        function saveToDb(type, title, isFinal) {
            // åªæœ‰åœ¨ isFinal ä¸º trueï¼ˆç‚¹å‡»æŒ‰é’®ï¼‰æ—¶æ‰æ‰§è¡Œä¿å­˜
            if (!isFinal) return;

            // 1. å¤„ç†æœªå‘½åæƒ…å†µ
            let finalTitle = title.trim() || "æœªå‘½åå†³ç­–";

            // 2. è·å–å½“å‰æ¨¡å¼çš„æ•°æ®å¿«ç…§
            let data = {};
            if (type === 'balance') {
                data = {
                    pros: [...document.querySelectorAll('.p-i')].map(el => el.value),
                    cons: [...document.querySelectorAll('.c-i')].map(el => el.value),
                    res: document.getElementById('bal-res-panel').innerText
                };
            } else if (type === 'advanced') {
                data = {
                    crits: [...document.querySelectorAll('.c-n')].map((el, i) => ({ n: el.value, w: document.querySelectorAll('.c-w')[i].value })),
                    objs: [...document.querySelectorAll('.o-n')].map(el => el.value),
                    matrix: { ...currentMatrixData },
                    res: document.getElementById('adv-res-panel').innerText
                };
            } else if (type === 'random') {
                data = {
                    opts: [...document.querySelectorAll('.r-i')].map(el => el.value),
                    res: document.getElementById('ran-res-panel').innerText
                };
            }

            // 3. æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åŒåè®°å½•ï¼ˆç”¨äºæ›¿æ¢é€»è¾‘ï¼‰
            // æ³¨æ„ï¼šè¿™é‡Œçš„ currentHistoryId æ˜¯ä½ åœ¨ loadHistory æ—¶ä¿å­˜çš„é‚£ä¸ªåŸå§‹ ID
            const existingIndex = db.findIndex(item => item.title === finalTitle);

            if (existingIndex !== -1) {
                // å¦‚æœæ ‡é¢˜æ²¡å˜ï¼Œä¸”è¿™ä¸ªæ ‡é¢˜å¯¹åº”çš„å°±æ˜¯å½“å‰æ‰“å¼€çš„è¿™æ¡è®°å½•ï¼Œåˆ™æ›¿æ¢
                // å¦‚æœæ ‡é¢˜æ²¡å˜ï¼Œä½†å½“å‰æ˜¯æ–°å»ºçŠ¶æ€ï¼Œåˆ™è§¦å‘â€œé‡ååŠ åºå·â€å¦å­˜ä¸º
                if (window.currentOpeningTitle === finalTitle) {
                    db[existingIndex] = { id: Date.now(), type, title: finalTitle, data, time: new Date().toLocaleString() };
                } else {
                    // é‡åå¤„ç†ï¼šå¦å­˜ä¸ºâ€œæ ‡é¢˜(1)â€
                    let count = 1;
                    let newTitle = `${finalTitle}(${count})`;
                    while (db.some(item => item.title === newTitle)) {
                        count++;
                        newTitle = `${finalTitle}(${count})`;
                    }
                    db.unshift({ id: Date.now(), type, title: newTitle, data, time: new Date().toLocaleString() });
                }
            } else {
                // æ ‡é¢˜å˜äº†æˆ–è€…æ˜¯å…¨æ–°æ ‡é¢˜ï¼šå¦å­˜ä¸ºæ–°è®°å½•
                db.unshift({ id: Date.now(), type, title: finalTitle, data, time: new Date().toLocaleString() });
            }

            // 4. æŒä¹…åŒ–å¹¶åˆ·æ–°ç•Œé¢
            localStorage.setItem('terminal_db_vfinal', JSON.stringify(db));
            renderHistoryList();
            // æ›´æ–°å½“å‰æ­£åœ¨æ“ä½œçš„æ ‡é¢˜çŠ¶æ€
            window.currentOpeningTitle = finalTitle;
        }

        function getSnapshot(type) {
            if (type === 'balance') {
                return {
                    pros: [...document.querySelectorAll('#pro-list .input-inner')].map((el, i) => ({ n: el.value, s: document.querySelectorAll('#pro-list .star-group')[i].dataset.score })),
                    cons: [...document.querySelectorAll('#con-list .input-inner')].map((el, i) => ({ n: el.value, s: document.querySelectorAll('#con-list .star-group')[i].dataset.score }))
                };
            } else if (type === 'advanced') {
                return {
                    crits: [...document.querySelectorAll('.c-n')].map((el, i) => ({ n: el.value, w: document.querySelectorAll('.c-w')[i].value })),
                    objs: [...document.querySelectorAll('.o-n')].map(el => el.value),
                    matrix: currentMatrixData
                };
            } else {
                return { opts: [...document.querySelectorAll('.r-i')].map(el => el.value) };
            }
        }

        // æ¨¡å¼å¼€å¯ä¸åˆå§‹åŒ–
        function openMode(mode) {
            activeId = null; currentMatrixData = {};
            if (mode === 'balance') {
                document.getElementById('bal-title').value = "";
                document.getElementById('pro-list').innerHTML = ""; document.getElementById('con-list').innerHTML = "";
                addBalItem('pro', 'èº«å¿ƒæ„‰æ‚¦'); addBalItem('con', 'é’±åŒ…ç¼©æ°´');
                document.getElementById('bal-res-panel').classList.add('hidden');
                switchPage('balance');
            } else if (mode === 'advanced') {
                document.getElementById('adv-title').value = "";
                document.getElementById('crit-list').innerHTML = ""; document.getElementById('obj-list').innerHTML = "";
                addCritField('è–ªèµ„', 50); addObjField('å…¬å¸A'); addObjField('å…¬å¸B');
                toggleScoring(false); switchPage('advanced');
            } else {
                document.getElementById('ran-title').value = ""; document.getElementById('ran-list').innerHTML = "";
                addRanField('ç«é”…'); addRanField('æ—¥æ–™');
                document.getElementById('ran-machine').classList.add('hidden');
                document.getElementById('ran-res-panel').innerText = "";
                switchPage('random');
            }
        }

        // å¤©å¹³æ¨¡å¼
        function addBalItem(type, name = '', score = 3) {
            const div = document.createElement('div');
            div.className = `input-group ${type === 'pro' ? 'pro-bg' : 'con-bg'}`;
            div.style.flexDirection = 'column'; div.style.alignItems = 'flex-start'; div.style.padding = '10px';
            div.innerHTML = `<div style="display:flex; width:100%">
            <input type="text" class="input-inner" value="${name}" placeholder="è¾“å…¥é¡¹ç›®" oninput="checkLen(this, 30)" style="flex:1; font-weight:bold;">
            <span class="del-btn" onclick="removeBalItem(this, '${type}')">âœ•</span></div>
            <div class="star-group" data-score="${score}">${[1, 2, 3, 4, 5].map(v => `<div class="star-box ${v <= score ? 'active' : ''}" onclick="setStar(this, ${v})">â˜…</div>`).join('')}</div>`;
            document.getElementById(`${type}-list`).appendChild(div);
        }
        function removeBalItem(el, type) {
            if (canDelete(`${type}-list`, 1)) el.closest('.input-group').remove();
            else openModal("âš ï¸ è‡³å°‘å¾—ç•™ä¸€ä¸ªå§");
        }

        function addCritField(n = "", w = 50) {
            const div = document.createElement('div');
            div.className = 'crit-card'; // æ¢å¤åŸæœ¬çš„ç±»å
            div.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <input type="text" class="c-n" value="${n}" placeholder="æ ‡å‡†(å¦‚ï¼šä»·æ ¼)" oninput="checkLen(this, 30)" style="border:none; background:none; outline:none; font-weight:bold; width:80%;">
            <span class="del-btn" onclick="removeCrit(this)">âœ•</span>
        </div>
        <div style="font-size:11px; display:flex; gap:10px; align-items:center;">
            æƒé‡: <input type="range" class="c-w" value="${w}" style="flex:1" oninput="this.nextElementSibling.innerText=this.value+'%'">
            <span>${w}%</span>
        </div>`;
            document.getElementById('crit-list').appendChild(div);
        }

        // å¯¹åº”çš„åˆ é™¤ä¿æŠ¤é€»è¾‘
        function removeCrit(el) {
            // è·å–å½“å‰é¡µé¢ä¸Šæ‰€æœ‰è¯„ä»·æ ‡å‡†çš„æ•°é‡
            const count = document.querySelectorAll('.crit-card').length;
            if (count <= 1) {
                openModal("âš–ï¸ è¯·è‡³å°‘ä¿ç•™ä¸€ä¸ªè¯„ä»·æ ‡å‡†ã€‚");
                return;
            }
            el.closest('.crit-card').remove();
        }

        function addObjField(n = "") {
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
        <input type="text" class="o-n" value="${n}" placeholder="å¯¹è±¡åç§°" oninput="checkLen(this, 12)" style="flex:1">
        <span class="del-btn" onclick="removeObj(this)">âœ•</span>
    `;
            document.getElementById('obj-list').appendChild(div);
        }

        function removeObj(el) {
            if (document.querySelectorAll('.o-n').length <= 2) {
                openModal("âš ï¸ è‡³å°‘éœ€è¦ä¸¤ä¸ªæ¯”è¾ƒå¯¹è±¡æ‰èƒ½è¿›è¡Œå¯¹æ¯”ã€‚");
                return;
            }
            el.closest('.input-group').remove();
        }
        function toggleScoring(show) { document.getElementById('adv-setup').classList.toggle('hidden', show); document.getElementById('adv-scoring-ui').classList.toggle('hidden', !show); }

        function goScoringPage() {
            // --- æ ¸å¿ƒä¿®å¤ï¼šé‡ç½®çŠ¶æ€ ---
            currentMatrixData = {}; // æ¸…ç©ºä¹‹å‰çš„æ‰“åˆ†æ•°æ®
            const resPanel = document.getElementById('adv-res-panel');
            if (resPanel) {
                resPanel.innerHTML = "";     // æ¸…ç©ºä¸Šä¸€æ¬¡çš„è®¡ç®—ç»“æœæ–‡å­—
                resPanel.classList.add('hidden'); // éšè—ç»“æœé¢æ¿
            }
            // -----------------------

            const objs = [...document.querySelectorAll('.o-n')].map(el => el.value.trim()).filter(v => v);
            const crits = [...document.querySelectorAll('.c-n')].map((el, i) => {
                const weightEl = document.querySelectorAll('.c-w')[i];
                return {
                    n: el.value.trim(),
                    w: weightEl ? parseInt(weightEl.value) || 0 : 0
                };
            }).filter(c => c.n !== "");

            if (objs.length < 2) {
                openModal("âš ï¸ è‡³å°‘éœ€è¦ä¸¤ä¸ªæ¯”è¾ƒå¯¹è±¡ã€‚");
                return;
            }
            if (crits.length < 1) {
                openModal("âš–ï¸ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè¯„ä»·æ ‡å‡†ã€‚");
                return;
            }

            // æ¸²æŸ“æ‰“åˆ†çŸ©é˜µ
            const matrix = document.getElementById('scoring-matrix');
            matrix.innerHTML = objs.map((o, oi) => `
        <div class="crit-card">
            <h4 style="margin:0 0 10px; color:var(--primary)">å¯¹ ${o} æ‰“åˆ†</h4>
            ${crits.map((c, ci) => {
                // é»˜è®¤åˆ†æ•°ä¸º 3
                const s = 3;
                currentMatrixData[`${oi}-${ci}`] = s; // åŒæ­¥åˆå§‹åŒ–æ•°æ®
                return `
                <div style="margin-bottom:12px; font-size:12px; color:#666;">${c.n} (${c.w}%æƒé‡)
                    <div class="star-group" data-o="${oi}" data-c="${ci}" data-score="${s}">
                        ${[1, 2, 3, 4, 5].map(v => `<div class="star-box ${v <= s ? 'active' : ''}" onclick="setStar(this, ${v})">â˜…</div>`).join('')}
                    </div>
                </div>`
            }).join('')}
        </div>`).join('');

            toggleScoring(true);
        }

        function addRanField(v = "") {
            const div = document.createElement('div');
            div.className = 'input-group';
            // å…³é”®ï¼šä¿ç•™ä½ çš„ span æ ‡ç­¾å’Œ del-btn ç±»åï¼Œåªä¿®æ”¹ onclick
            div.innerHTML = `
        <input type="text" class="r-i" value="${v}" placeholder="é€‰é¡¹" oninput="checkLen(this, 30)" style="flex:1">
        <span class="del-btn" onclick="removeRan(this)">âœ•</span>
    `;
            document.getElementById('ran-list').appendChild(div);
        }

        function removeRan(el) {
            // æ£€æŸ¥ .r-i çš„æ•°é‡æ˜¯å¦å°äºç­‰äº 2
            if (document.querySelectorAll('.r-i').length <= 2) {
                openModal("ğŸ° è‡³å°‘éœ€è¦ä¿ç•™ä¸¤ä¸ªé€‰é¡¹ï¼Œå¦åˆ™æ— æ³•å¼€å¯éšæœºå†³ç­–ã€‚");
                return;
            }
            el.closest('.input-group').remove();
        }


        // é€šç”¨æ‰“åˆ†
        function setStar(el, v) {
            const g = el.parentElement; g.dataset.score = v;
            g.querySelectorAll('.star-box').forEach((s, i) => s.classList.toggle('active', i < v));
            if (g.dataset.o !== undefined) currentMatrixData[`${g.dataset.o}-${g.dataset.c}`] = v;
        }

        // è®¡ç®—é€»è¾‘
        function doCalcBalance() {
            const pS = [...document.querySelectorAll('#pro-list .star-group')].reduce((a, b) => a + parseInt(b.dataset.score), 0);
            const cS = [...document.querySelectorAll('#con-list .star-group')].reduce((a, b) => a + parseInt(b.dataset.score), 0);
            const diff = pS - cS;
            const panel = document.getElementById('bal-res-panel'); panel.classList.remove('hidden');


            let msg = "";
            let textColor = "";

            // æé«˜æ”¶ç›ŠåŒº
            if (diff >= 10) {
                msg = "è¿™æ˜¯å¤©èµè‰¯æœºï¼buff å æ»¡äº†ï¼Œä¸å†²è¿˜æ˜¯äººï¼ŸğŸ”¥";
                panel.style.background = "#e6fffa";
                textColor = "#00b894";
            }
            // é«˜æ”¶ç›ŠåŒº
            else if (diff >= 8) {
                msg = "ä¼˜åŠ¿åœ¨æˆ‘ï¼è¿™ç§èƒœç®—ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æå‰åº†ç¥äº†ã€‚ğŸ†";
                panel.style.background = "#e6fffa";
                textColor = "#00b894";
            }
            // ä¸­é«˜æ”¶ç›ŠåŒº
            else if (diff >= 5) {
                msg = "æ”¶ç›Šç¢¾å‹é£é™©ï¼Œé—­ç€çœ¼é€‰éƒ½ä¸ä¼šé”™ã€‚ğŸš€";
                panel.style.background = "#e6fffa";
                textColor = "#00b894";
            }
            // ä¸­ä½æ”¶ç›ŠåŒº
            else if (diff >= 3) {
                msg = "åˆ©å¤§äºå¼Šã€‚è™½ç„¶æœ‰å°ç‘•ç–µï¼Œä½†æ•´ä½“æ–¹å‘éå¸¸æ­£ç¡®ã€‚âœ¨";
                panel.style.background = "#e6fffa";
                textColor = "#00b894";
            }
            // å¾®å¼±æ”¶ç›ŠåŒº
            else if (diff > 0) {
                msg = "ç•¥èƒœä¸€ç­¹ã€‚å¤©å¹³ç¨å¾®æ–œäº†ä¸€ä¸‹ï¼Œå»ºè®®é¡ºåŠ¿è€Œä¸ºã€‚ğŸƒ";
                panel.style.background = "#e6fffa";
                textColor = "#00b894";
            }
            // ç»å¯¹å¹³è¡¡åŒº
            else if (diff === 0) {
                msg = "å®‡å®™çš„ç»ˆæå¹³è¡¡ã€‚æŠ›ä¸ªç¡¬å¸å§ï¼Œæˆ–è€…å†æ‰¾ä¸ªç†ç”±ï¼Ÿâš–ï¸";
                panel.style.background = "#f1f3f5";
                textColor = "#636e72";
            }
            // å¾®å¼±é£é™©åŒº
            else if (diff >= -2) {
                msg = "æœ‰ç‚¹çŠ¹è±«ï¼Ÿè¿™å¾®å¼±çš„åŠ£åŠ¿å¯èƒ½å°±æ˜¯ä½ ç›´è§‰çš„è­¦å‘Šã€‚ğŸ¤”";
                panel.style.background = "#fff5f5";
                textColor = "#ff7675";
            }
            // ä¸­ä½é£é™©åŒº
            else if (diff >= -5) {
                msg = "æœ‰ç‚¹æ‚¬ã€‚ä»£ä»·éšçº¦å¯è§ï¼Œå»ºè®®å†ç­‰ç­‰çœ‹ã€‚âš ï¸";
                panel.style.background = "#fff5f5";
                textColor = "#ff7675";
            }
            // ä¸­é«˜é£é™©åŒº
            else if (diff >= -8) {
                msg = "å¿«é€ƒï¼è¿™å‘æœ‰ç‚¹æ·±ï¼Œåˆ«ç”¨ä½ çš„å¥½å¥‡å¿ƒå»æŒ‘æˆ˜å®ƒã€‚ğŸš«";
                panel.style.background = "#fff5f5";
                textColor = "#ff7675";
            }
            // æé«˜é£é™©åŒº
            else {
                msg = "äººé—´æ¸…é†’ï¼å“ªæ€•åªæœ‰ 1% çš„ç†æ™ºï¼Œä¹Ÿè¦æ‹’ç»å®ƒï¼ğŸš©";
                panel.style.background = "#fff5f5";
                textColor = "#ff7675";
            }

            // æ¸²æŸ“é¢æ¿
            panel.style.color = textColor;
            panel.innerHTML = `
            <div style="font-weight:bold; font-size:1.1rem; line-height:1.4;">${msg}</div>
            <div style="margin-top:8px; font-size:12px; opacity:0.7;">
            ç»¼åˆè¯„åˆ†å·®å€¼ï¼š<span style="font-family:monospace; font-weight:bold;">${diff > 0 ? '+' + diff : diff}</span>
            </div>
            `;

            panel.innerHTML = `<div style="font-weight:bold; font-size:1.1rem;">${msg}</div><small style="color:#888;">ç»¼åˆåˆ†å·®: ${diff > 0 ? '+' + diff : diff}</small>`;
            panel.innerHTML += getRandomTip(); // è°ƒç”¨éšæœºæŠ€å·§å‡½æ•°

            saveToDb('balance', document.getElementById('bal-title').value, true);
        }

        function doCalcAdvanced() {
            const crits = [...document.querySelectorAll('.c-w')].map(el => parseInt(el.value));
            const objs = [...document.querySelectorAll('.o-n')].map(el => el.value);

            // 1. è®¡ç®—æ‰€æœ‰å¯¹è±¡å¾—åˆ†å¹¶æ’åº
            const res = objs.map((name, oi) => {
                let total = 0;
                crits.forEach((w, ci) => {
                    total += (currentMatrixData[`${oi}-${ci}`] || 3) * (w / 100);
                });
                return { name, score: parseFloat(total.toFixed(1)) }; // è½¬æ¢ä¸ºæµ®ç‚¹æ•°æ–¹ä¾¿åç»­è®¡ç®—
            }).sort((a, b) => b.score - a.score);

            // 2. è·å–é¢æ¿å¹¶å‡†å¤‡æ–‡æ¡ˆ
            const p = document.getElementById('adv-res-panel');
            p.classList.remove('hidden');

            const top1 = res[0];
            const top2 = res[1];
            const margin = (top1.score - top2.score).toFixed(1); // è®¡ç®—åˆ†å·®

            let advice = "";
            let themeColor = "var(--primary)";

            // 3. æ ¹æ®é¢†å…ˆå¹…åº¦å†³å®šæ–‡æ¡ˆ
            if (margin >= 2.0) {
                advice = `ğŸ‘‘ ${top1.name} ä»¥ç»å¯¹ä¼˜åŠ¿èƒœå‡ºï¼åœ¨ä½ çš„é€»è¾‘é‡Œï¼Œå®ƒå‡ ä¹æ²¡æœ‰å¯¹æ‰‹ã€‚`;
            }
            else if (margin >= 1.0) {
                advice = `ğŸ¯ ä¼˜é€‰æ–¹æ¡ˆæ˜¯ ${top1.name}ï¼Œå®ƒçš„å¤šç»´åº¦è¡¨ç°æ˜æ˜¾æ›´ç¨³å¥ã€‚`;
            }
            else if (margin >= 0.5) {
                advice = `âš–ï¸ ${top1.name} é™©èƒœï¼è™½ç„¶é¢†å…ˆä¸å¤šï¼Œä½†ä¾ç„¶æ˜¯ç†æ€§è®¡ç®—åçš„æœ€ä½³é€‰æ‹©ã€‚`;
            }
            else if (margin > 0) {
                advice = `ğŸŒ“ å·®è·æå°ï¼${top1.name} å’Œ ${top2.name} è¡¨ç°ç›¸å½“ï¼Œå‡­ç›´è§‰é€‰ä¸€ä¸ªå§ã€‚`;
                themeColor = "#636e72"; // å·®è·å°æ—¶é¢œè‰²å˜æ·¡
            }
            else {
                advice = `ğŸ å¥‡è¿¹èˆ¬çš„å¹³å±€ï¼è¿™ä¸¤ä¸ªé€‰é¡¹åœ¨ä½ çš„æƒé‡ä½“ç³»ä¸‹å®Œå…¨ç­‰å€¼ã€‚`;
                themeColor = "#636e72";
            }

            // 4. æ¸²æŸ“ä¸°å¯Œåçš„ç»“æœç•Œé¢
            p.style.border = `2px solid ${themeColor}`;
            p.style.background = "#f8f9ff";
            p.innerHTML = `
            <div style="color:${themeColor}; font-weight:bold; font-size:1.1rem; line-height:1.4;">${advice}</div>
            <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
            ${res.slice(0, 3).map((item, idx) => `
                <div style="font-size:12px; display:flex; justify-content:space-between; margin-bottom:4px; opacity:${idx === 0 ? 1 : 0.6}">
                    <span>${idx === 0 ? 'ğŸ†' : (idx + 1) + '.'} ${item.name}</span>
                    <span style="font-family:monospace; font-weight:bold;">${item.score} åˆ†</span>
                </div>
            `).join('')}
            </div>
            `;

            p.innerHTML += getRandomTip(); // è°ƒç”¨éšæœºæŠ€å·§å‡½æ•°

            // 5. ä¿å­˜å†³ç­–
            saveToDb('advanced', document.getElementById('adv-title').value, true);
        }

        function doRandomDecision() {
            // 1. ä¸¥æ ¼æ£€æŸ¥é€‰é¡¹æ•°é‡
            const opts = [...document.querySelectorAll('.r-i')].map(el => el.value.trim()).filter(v => v);
            if (opts.length < 2) {
                openModal("ğŸ° ä¸¤ä¸ªä»¥ä¸Šé€‰é¡¹æ‰èƒ½å¼€å¯éšæœºå†³ç­–");
                return; // æ‹¦æˆªå¹¶é€€å‡º
            }

            // 2. è·å–å¿…è¦çš„ DOM å…ƒç´ 
            const track = document.getElementById('ran-track');
            const machine = document.getElementById('ran-machine');
            const resPanel = document.getElementById('ran-res-panel');
            const titleInput = document.getElementById('ran-title');

            if (!track || !machine) return;

            // 3. åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
            machine.classList.remove('hidden');
            resPanel.innerHTML = ""; // æ¸…ç©ºæ—§ç»“æœ
            resPanel.classList.add('hidden'); // åŠ¨ç”»æœŸé—´éšè—ç»“æœé¢æ¿

            // 4. æ„å»ºè½¬ç›˜å†…å®¹
            track.innerHTML = Array(15).fill(opts).flat().map(o =>
                `<div style="height:80px; line-height:80px; text-align:center; color:white; font-weight:bold; font-size:1.2rem;">${o}</div>`
            ).join('');

            const winIdx = Math.floor(Math.random() * opts.length);
            track.style.transition = 'none';
            track.style.transform = 'translateY(0)';

            // 5. å¯åŠ¨åŠ¨ç”»
            setTimeout(() => {
                track.style.transition = 'transform 3s cubic-bezier(0.1, 0, 0.1, 1)';
                track.style.transform = `translateY(-${(opts.length * 12 + winIdx) * 80}px)`;
            }, 50);

            // 6. ç»“æœå¤„ç†
            setTimeout(() => {
                const winner = opts[winIdx];
                const title = titleInput ? titleInput.value.trim() : "";

                let html = `<div style="font-size:1.2rem; font-weight:bold;">âœ¨ å†³ç­–ç»“æœï¼š${winner}</div>`;
                html += getRandomTip(); // è°ƒç”¨éšæœºæŠ€å·§å‡½æ•°

                resPanel.innerHTML = html;
                resPanel.classList.remove('hidden'); // æ˜¾ç¤ºç»“æœ

                // è§¦å‘å­˜æ¡£
                saveToDb('random', title, true);
            }, 3100);
        }

        // å†å²ç®¡ç†
        function renderHistoryList() {
            const c = document.getElementById('history-container');
            c.innerHTML = db.length ? '' : '<p style="text-align:center; color:#ccc; margin-top:100px;">æš‚æ— å†å²è®°å½•</p>';

            db.forEach((h, i) => {
                const div = document.createElement('div');
                div.className = 'mode-card history-item';
                div.draggable = true;
                div.dataset.id = h.id; // ã€æ–°å¢ã€‘å­˜å‚¨å”¯ä¸€IDï¼Œç”¨äºæ’åºè¯†åˆ«

                div.innerHTML = `<div style="flex:1" onclick="loadHist(${i})">
            <span class="mode-tag" style="background:${getModeColor(h.type)}">${getModeName(h.type)}</span>
            <span style="font-size:10px; color:var(--text-muted); float:right;">å›çœ‹ ${h.count || 0} æ¬¡</span>
            <div style="font-weight:bold; margin-top:4px;">${h.title}</div><div style="font-size:10px; color:#ccc;">${h.time}</div>
        </div><span class="del-btn" onclick="event.stopPropagation(); deleteItem(${i})">âœ•</span>`;

                div.addEventListener('dragstart', () => div.classList.add('dragging'));
                div.addEventListener('dragend', () => {
                    div.classList.remove('dragging');
                    saveNewOrder();
                });
                c.appendChild(div);
            });

            // ç¡®ä¿æ‹–æ‹½äº‹ä»¶åªç»‘å®šä¸€æ¬¡ï¼Œé¿å…é‡å¤ç»‘å®šå¯¼è‡´çš„é€»è¾‘é”™ä¹±
            c.ondragover = e => {
                e.preventDefault();
                const d = document.querySelector('.dragging');
                const a = getDragAfterElement(c, e.clientY);
                if (!a) c.appendChild(d);
                else c.insertBefore(d, a);
            };
        }

        function getDragAfterElement(container, y) {
            const elements = [...container.querySelectorAll('.history-item:not(.dragging)')];
            return elements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function saveNewOrder() {
            const items = [...document.querySelectorAll('.history-item')];
            // é€šè¿‡ dataset è·å–å­˜å‚¨åœ¨ DOM ä¸Šçš„å”¯ä¸€ ID
            const newDb = items.map(it => {
                const id = parseInt(it.dataset.id);
                return db.find(d => d.id === id);
            }).filter(Boolean);

            // æ›´æ–°å…¨å±€å˜é‡å’Œæœ¬åœ°å­˜å‚¨
            db = newDb;
            localStorage.setItem('terminal_db_vfinal', JSON.stringify(db)); // ç¡®ä¿è¿™é‡Œçš„ Key å’Œä½ ä¿å­˜æ—¶ç”¨çš„ä¸€è‡´

            // å…³é”®ï¼šé‡æ–°æ¸²æŸ“ä¸€éï¼Œä»¥æ›´æ–°æ¯ä¸ª DOM å…ƒç´ ç»‘å®šçš„ loadHist(i) ç´¢å¼•
            renderHistoryList();
        }

        function loadHist(i) {
            const h = db[i]; activeId = h.id; h.count = (h.count || 0) + 1;
            window.currentOpeningTitle = h.title; // æ–°å¢ï¼šè®°å½•å½“å‰æ‰“å¼€çš„æ ‡é¢˜
            localStorage.setItem('terminal_db_vfinal', JSON.stringify(db));
            if (h.type === 'balance') {
                switchPage('balance'); document.getElementById('bal-title').value = h.title;
                document.getElementById('pro-list').innerHTML = ""; document.getElementById('con-list').innerHTML = "";
                h.data.pros.forEach(p => addBalItem('pro', p.n, p.s)); h.data.cons.forEach(c => addBalItem('con', c.n, c.s));
                document.getElementById('bal-res-panel').classList.add('hidden');
            } else if (h.type === 'advanced') {
                switchPage('advanced'); document.getElementById('adv-title').value = h.title;
                document.getElementById('crit-list').innerHTML = ""; document.getElementById('obj-list').innerHTML = "";
                h.data.crits.forEach(c => addCritField(c.n, c.w)); h.data.objs.forEach(o => addObjField(o));
                currentMatrixData = h.data.matrix || {}; toggleScoring(false);
            } else {
                switchPage('random'); document.getElementById('ran-title').value = h.title;
                document.getElementById('ran-list').innerHTML = ""; h.data.opts.forEach(o => addRanField(o));
                document.getElementById('ran-res-panel').innerText = "";
            }
        }

        // æ¸…ç©ºè‡ªåŠ¨ä¿å­˜é€»è¾‘ï¼Œä¸å†ç›‘å¬è¾“å…¥æ¡†å¤±ç„¦
        function autoSaveAfterTitleInput(type) {
            // æ­¤å¤„ç•™ç©º
        }

        // æ‰¾åˆ° deleteItem å‡½æ•°è¿›è¡Œä¿®æ”¹
        function deleteItem(i) {
            openModal("âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™æ¡å†³ç­–å—ï¼Ÿ", () => {
                db.splice(i, 1);
                localStorage.setItem('terminal_db_vfinal', JSON.stringify(db));
                renderHistoryList();
            });
        }

        // function deleteItem(i) { if (confirm("åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ")) { db.splice(i, 1); localStorage.setItem('terminal_db_vfinal', JSON.stringify(db)); renderHistoryList(); } }
        function getModeName(t) { return { balance: 'å¤©å¹³å†³ç­–', advanced: 'å¯¹æ¯”å†³ç­–', random: 'éšæœºå†³ç­–' }[t]; }
        function getModeColor(t) { return { balance: 'var(--secondary)', advanced: 'var(--primary)', random: 'var(--accent)' }[t]; }

        /**
        * @param {string} msg æç¤ºæ–‡å­—
        * @param {function} onConfirm ç¡®å®šåçš„å›è°ƒï¼ˆå¦‚æœä¸ä¼ ï¼Œåˆ™åªæ˜¾ç¤ºç¡®å®šæŒ‰é’®ï¼Œç›¸å½“äºalertï¼‰
        */
        function openModal(msg, onConfirm = null) {
            const overlay = document.getElementById('custom-modal-overlay');
            const modalBody = document.getElementById('modal-body');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalBody.innerText = msg;
            overlay.classList.remove('hidden');

            // å¦‚æœæ²¡æœ‰ä¼ å›è°ƒï¼Œè¯´æ˜åªæ˜¯æ™®é€šè­¦å‘Šï¼Œéšè—å–æ¶ˆæŒ‰é’®
            if (!onConfirm) {
                cancelBtn.classList.add('hidden');
                confirmBtn.style.width = '100%';
            } else {
                cancelBtn.classList.remove('hidden');
                confirmBtn.style.width = 'auto';
            }

            // ç¡®å®šæŒ‰é’®é€»è¾‘
            confirmBtn.onclick = () => {
                overlay.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            // å–æ¶ˆæŒ‰é’®é€»è¾‘
            cancelBtn.onclick = () => {
                overlay.classList.add('hidden');
            };
        }

        const userTips = [
            //è½¯ä»¶ä½¿ç”¨
            "ğŸ’¡ ç‚¹å‡»å¼€å§‹å†³ç­–ï¼Œå†³ç­–å°†è‡ªåŠ¨ä¿å­˜åœ¨å†å²è®°å½•ä¸­ã€‚",
            "ğŸ’¡ å¯¹æ¯”æ¨¡å¼ä¸­ï¼Œç‚¹å‡»æ˜Ÿæ˜Ÿå³å¯æ‰“åˆ†ã€‚å¦‚æœæŸä¸ªæ ‡å‡†å®Œå…¨ä¸é‡è¦ï¼ŒæŠŠæƒé‡æ‹‰åˆ°æœ€ä½å³å¯ã€‚",
            "ğŸ’¡ å¤©å¹³æ¨¡å¼æ›´é€‚åˆâ€˜åšæˆ–ä¸åšâ€™çš„çº ç»“ï¼Œè€Œå¯¹æ¯”æ¨¡å¼é€‚åˆâ€˜é€‰ A è¿˜æ˜¯é€‰ Bâ€™ã€‚",
            "ğŸ’¡ å¦‚æœä¸å°å¿ƒåˆ é”™äº†é€‰é¡¹ï¼Œåªè¦è¿˜æ²¡ç‚¹å¼€å§‹å†³ç­–ï¼Œé‡æ–°åŠ è½½å†å²è®°å½•å³å¯æ‰¾å›ã€‚",
            "ğŸ’¡ å°†ç½‘é¡µâ€˜æ·»åŠ åˆ°ä¸»å±å¹•â€™ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨ã€‚",
            "ğŸ’¡ åœ¨å†å²è®°å½•é¡µé¢é•¿æŒ‰æ‹–åŠ¨å†³ç­–ï¼Œå¯ä»¥è°ƒæ•´å†³ç­–çš„é¡ºåºã€‚",
            "ğŸ’¡ å†³ç­–æ ‡é¢˜æœ€å¤šåªèƒ½20ä¸ªå­—å“¦ã€‚",
            "ğŸ’¡ å¿˜è®°å†™å†³ç­–æ ‡é¢˜äº†ï¼Ÿæ²¡å…³ç³»ï¼Œä½ çš„å†³ç­–å·²ç»è‡ªåŠ¨ä¿å­˜ä¸ºæœªå‘½åå†³ç­–ã€‚",
            "ğŸ’¡ æ ‡é¢˜é‡å¤çš„å†³ç­–ä¿å­˜å†å²è®°å½•æ—¶ä¼šè‡ªåŠ¨æ·»åŠ åºå·ã€‚",
            "ğŸ’¡ å†å²å†³ç­–åªæœ‰ä¿®æ”¹æ ‡é¢˜åæ‰ä¼šå¦å­˜ä¸ºæ–°çš„è®°å½•ï¼Œå¦åˆ™å°†ä¼šæ›¿æ¢åŸæœ¬è®°å½•ã€‚",
            //å†³ç­–æœ¬èº«
            "ğŸ’¡ å¦‚æœç»“æœä¸æ»¡æ„ï¼Œè¯´æ˜ä½ å¿ƒé‡Œæ—©æœ‰ç­”æ¡ˆï¼Œå¬ä»å†…å¿ƒå§ã€‚",
            "ğŸ’¡ å°è¯•åœ¨ä¸åŒæ—¶é—´ç‚¹è¿›è¡ŒåŒä¸€å†³ç­–ï¼Œçœ‹å¿ƒå¢ƒçš„å˜åŒ–ã€‚",
            "ğŸ’¡ éšæœºæ¨¡å¼ä¸ä»…èƒ½é€‰åƒçš„ï¼Œè¿˜èƒ½å†³å®šè°å»æ´—ç¢—ã€‚",
            "ğŸ’¡ æƒé‡è®¾ç½®å¾—è¶Šæç«¯ï¼Œç»“è®ºçš„å€¾å‘æ€§å°±è¶Šæ˜æ˜¾ã€‚å®ƒèƒ½å¸®ä½ æŒ–æ˜å†…å¿ƒæ·±å¤„çš„åè§ã€‚",
            "ğŸ’¡ å¦‚æœå¤©å¹³ä¸¤ç«¯åˆ†å€¼æ——é¼“ç›¸å½“ï¼Œä¸å¦‚è¯•è¯•éšæœºæ¨¡å¼ï¼Œè®©å‘½è¿æ¥æ¨ä½ ä¸€æŠŠã€‚",
            "ğŸ’¡ æ²¡æœ‰å®Œç¾çš„å†³ç­–ï¼Œåªæœ‰ä¸åæ‚”çš„é€‰æ‹©ã€‚ç»ˆç«¯æœºåªæ˜¯å¸®ä½ ç†æ¸…é€»è¾‘çš„å·¥å…·ã€‚",
            "ğŸ’¡ æ·±å¤œåšçš„å†³å®šå¾€å¾€å¸¦æœ‰æƒ…ç»ªï¼Œå»ºè®®ä¿å­˜è®°å½•ï¼Œç­‰æ˜å¤©ç¡é†’äº†å†ç‚¹å¼€çœ‹ä¸€éã€‚",
            "ğŸ’¡ åœ¨å¤©å¹³æ¨¡å¼ä¸‹ï¼Œè¯•ç€æŠŠâ€˜æ²‰é»˜æˆæœ¬â€™ä¹Ÿåˆ—å…¥ä»£ä»·ä¸€æ ï¼Œä½ ä¼šå‘ç°æ”¾å¼ƒå¹¶ä¸å¯æ€•ã€‚",
            "ğŸ’¡ å¯¹æ¯”æ¨¡å¼çš„åˆ†å€¼æ˜¯åŸºäºåŠ æƒè®¡ç®—çš„ï¼Œé€»è¾‘æ¯”ç›´è§‰æ›´å®¢è§‚ã€‚",
            "ğŸ’¡ æ‰€æœ‰çš„å†å²è®°å½•éƒ½æ˜¯ä½ æˆé•¿çš„æ³¨è„šã€‚å®šæœŸå›é¡¾å†å²ï¼Œçœ‹çœ‹æ›¾ç»çº ç»“çš„äº‹ç°åœ¨è¿˜é‡è¦å—ï¼Ÿ"
        ];

        // è·å–éšæœºæç¤ºçš„å‡½æ•°
        function getRandomTip() {
            const index = Math.floor(Math.random() * userTips.length);
            return `<div class="user-skill-tip" style="margin-top:15px; padding-top:10px; border-top:1px dashed #eee; font-size:11px; color:var(--text-muted); text-align:center;">${userTips[index]}</div>`;
        }

    </script>
</body>

</html>